@model Indexresp
@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>
<div class="col-md-12 row">
    <form asp-action="Index" method="get" class="col-4">
        <div class="input-group input-group-sm ">
            <input class="form-control" type="text" placeholder="Name" name="searchString" />
            <input class="btn btn-sm btn-primary" type="submit" value="Search" />
        </div>
    </form>
    <div>
        <a asp-controller="Shipment" asp-action="Index">
            <input type="submit" value="待出貨清單" class="btn" />
        </a>
    </div>
</div>

<div class="row">
    <div class="row col-md-12 d-inline">
        <div class="form-group">
            <a asp-action="Create">
                <input type="submit" value="+ 新增產品" class="add-product btn" />
            </a>
            <a asp-action="CreateCategory">
                <input type="submit" value="+ 新增類別" class="add-product btn" />
            </a>
        </div>
    </div>
    <div class="col-md-3 categories-container">
        @foreach (var item in Model.Categories)
        {
            <div class="form-group">
                <input class="categories-btn btn" type="submit" value="@item.Name" data-id="@item.Id" data-name="@item.Name" />
            </div>
        }
    </div>
    <div class="row col-md-9">
        <div class="row product-area">
            @foreach (var item in Model.Products)
            {
                <div class="col-md-4 product-list"
                     data-image="@item.Image"
                     data-category-name="@item.Category.Name"
                     data-name="@item.Name"
                     data-description="@item.Description">
                    <img id="@item.Id" />
                    <div class="col-md-12 category-name d-inline">
                        @item.Category.Name
                    </div>
                    <div>
                        @item.Name
                    </div>
                    <div class="category-description">
                        @item.Description
                    </div>
                    <button class="add-shipment">+</button>
                    <a asp-action="Edit" asp-route-id="@item.Id">Edit</a>
                    @if (ViewBag.ErrorMessage != null)
                    {
                        <div class="alert alert-danger">
                            @ViewBag.ErrorMessage
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>
@section Scripts {
    <script>

        const categoriesArr = '@Html.Raw(Model.Categories)';
        console.log(categoriesArr)
        
        $(document).ready(function () {
            // showImage();
        });

        // function showImage() {
        //     productsArr.forEach(row => {
        //         const imgElem = document.getElementById(row.Id);
        //         if (imgElem && imgElem.tagName.toLowerCase() === 'img') {
        //             imgElem.setAttribute('src', "data:image/jpg;base64," + row.Image);
        //         }
        //     });
        // }

        $('.categories-btn').on('click', function () {
            
            const id = $(this).attr('data-id');

            fetch(`/Products/CategoryFilter?id=${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(result => {
                console.log('成功:', result);
                $('.product-area').empty();

                result.forEach(product => {
                    $('.product-area').append(`
                        <div class="col-md-4 product-list">
                            <img id="${product.id}" />
                            <div class="col-md-12 category-name d-inline">
                                ${name}
                            </div>
                            <div>
                                ${product.name}
                            </div>
                            <div class="category-description">
                                ${product.description}
                            </div>
                            <button class="add-shipment">+</button>
                            <a asp-action="Edit" asp-route-id="${product.id}">Edit</a>
                        </div>
                    `);
                });

            })
            .catch(error => {
                console.error('錯誤:', error);
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.add-shipment').forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();

                    const productDiv = this.closest('.product-list');

                    const productName = productDiv.getAttribute('data-name');
                    const productCategory = productDiv.getAttribute('data-category-name');

                    const amount = 1;

                    fetch('/Shipment/SaveData', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ "ProductName": productName, "Amount": amount, "Category": productCategory })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                window.location.href = "/Shipment/Index";
                            } else {
                                alert('加入購物車發生錯誤');
                            }
                        })
                        .catch(error => console.error('Error:', error));
                });
            });
        });


    
    </script>
}
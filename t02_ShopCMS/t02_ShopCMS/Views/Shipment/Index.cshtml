@model ShipmentViewModel
@{
    ViewData["Title"] = "Shipment";
}

<div class="container col-md-7">
    <h4>待出貨清單</h4>
    <div class="form-container row d-flex justify-content-center align-items-center">
        <div class="shipment-list row p-0 mt-3">
            @foreach (var item in Model.Orders)
            {
                <div class="mb-4 d-flex justify-content-center align-items-center p-0">
                    <div class="form-check col-md-1 d-flex justify-content-center align-items-center p-0">
                        <input class="form-check-input order-checkbox" type="checkbox" value="" id="flexCheckDefault" data-id="@item.Id" data-product-name="@item.ProductName" data-amount="@item.Amount">
                        <label class="form-check-label" for="flexCheckDefault"></label>
                    </div>
                    <div class="row shipment-item col-md-11 d-flex align-items-center" data-product-name="@item.ProductName" data-category="@item.Category">
                        @foreach (var img in Model.Imgsrc[item.ProductId])
                        {
                            <img class="col-md-3" src="@img" />
                        }
                        <div class="col-md-5 title-name p-0 ms-2">
                            <div class="category-item d-inline" data-category="@item.Category">
                                @item.Category
                            </div>
                            <div class="mt-2 product-name" data-product-name="@item.ProductName">
                                @item.ProductName
                            </div>
                        </div>
                        <div class="col-md-3 quantity-control p-0">
                            <input type='button' value='-' class='qtyminus qty-btn d-flex justify-content-center align-items-center' field='quantity' />
                            <input type='text' value='@item.Amount' class='qty text-center' name='quantity' data-amount="@item.Amount" data-id="@item.Id" readonly />
                            <input type='button' value='+' class='qtyplus qty-btn d-flex justify-content-center align-items-center' field='quantity' />
                        </div>
                        <div class="col-md-1 form-group ms-5 d-flex justify-content-right">
                            <input type="submit" value="刪除" class="delete-btn btn-danger btn" data-id="@item.Id" style="padding: 3px 25px; font-size: 15px;" />
                        </div>
                    </div>
                </div>
            }
        </div>
        <div>
            <input type="submit" value="出貨" class="submit-btn btn" />
        </div>
    </div>
</div>

@section Scripts {
<script>
    const saveArray = [];

    $(function () {
        $('.qtyplus, .qtyminus').click(function (e) {
            e.preventDefault();
            var $this = $(this);
            var fieldName = $this.attr('field');
            var $input = $this.siblings('input[name=' + fieldName + ']');
            var currentVal = parseInt($input.val());

            if ($this.hasClass('qtyplus')) {
                $input.val(!isNaN(currentVal) ? currentVal + 1 : 0);
            } else if ($this.hasClass('qtyminus')) {
                $input.val(!isNaN(currentVal) && currentVal > 0 ? currentVal - 1 : 0);
            }

            const productDiv = this.closest('.shipment-item');
            const productName = productDiv.getAttribute('data-product-name');
            const productCategory = productDiv.getAttribute('data-category');

            const amount = parseInt($this.siblings('input[name=' + fieldName + ']').val());

            AmountSave(productName, productCategory, amount)
        });

        function AmountSave(productName, productCategory, amount) {
            
            fetch('/Shipment/SaveOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ "ProductName": productName, "Amount": amount, "Category": productCategory })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                } else {
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    $('.delete-btn').on('click', function () {
        const id = $(this).attr('data-id');

        fetch(`/Shipment/Delete?id=${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(response => response.json())
            .then(result => {
                console.log('成功:', result);
                location.reload();

            })
            .catch(error => {
                console.error('錯誤:', error);
            });
    })

    $('.order-checkbox').on('click', function () {
        const productName = $(this).attr('data-product-name');
        const amount = $(this).attr('data-amount');

        saveArray.push({ "ProductName": productName, "Amount": amount })
    })

    $('.submit-btn').on('click', async function () {
        console.log(saveArray)
        if (saveArray.length === 0) {
            swal.fire({
                title: "You didn't select any product",
                icon: "error"
            })
        } else {
            try{
                const response = await fetch('/Shipment/Order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(saveArray)
                })
                const data = await response.json();
                if (data.success) {
                    swal.fire({
                        icon: 'success',
                        title: '訂單成功',
                        text: '您的訂單已經成功處理',
                        confirmButtonText: '確定'
                    }).then(() => {
                        location.reload();
                        saveArray = [];
                    })
                } else {
                    swal.fire({
                        title: "Error occurred: 此產品已下架",
                        icon: "error",
                        confirmButtonText: '確定'
                    });
                }
            }
                catch(error) {
                    console.error('錯誤:', error);
                }
        }
    })

</script>
}